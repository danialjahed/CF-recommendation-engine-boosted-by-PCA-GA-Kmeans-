var async = require('async');
var db = require('mongo_schemas');
exports.get_recommended = function(userId, cb) {
    async.waterfall([
        function find_movie_indexes(cb) {
            db.rates.findOne({
                user_id: userId
            }, {
                recom_movie: {
                    $slice: 10
                }
            }).lean().exec(function(err, topRated) {
                if (err) {
                    console.mongo('Error', err);
                    return (cb(err, null));
                }
                if (topRated != null) {
                    let res_data = {};
                    res_data.status = true;
                    res_data.topRated = topRated.recom_movie;

                    return (cb(null, res_data));
                }
            });
        },
        function find_movie_title(res_data, cb) {
            db.movie_info.find({
                'movie_id': {
                    $in: res_data.topRated
                }
            }).lean().exec(function(err, info) {
                if (err) {
                    console.mongo('Error', err);
                    cb(err, null);
                }
                res_data.status = true;
                res_data.recom_movie = info;
                return (cb(null, res_data));
            });
        }
    ], function(err, result) {
        if (err) {
            return (cb(err, null));
        }
        return (cb(null, result));
    });
}
